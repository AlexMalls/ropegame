<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Giroscópio Tester – 1ª Pessoa</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121821;
      --text: #e7eef7;
      --muted: #94a3b8;
      --accent: #60a5fa;
      --danger: #f87171;
      --warn: #fbbf24;
      --radius: 12px;
      --cube: min(90vmin, 680px);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }

    .app { display: flex; flex-direction: column; height: 100%; }

    header { display:flex; flex-direction: column; gap: 6px; align-items:center; justify-content:center; padding: 8px; background: var(--panel); position: sticky; top:0; z-index: 10; }
    header h1 { font-size: 14px; margin:0; font-weight:600; text-align: center; }
    .controls { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
    button { flex: 1 1 auto; min-width: 100px; border:none; border-radius:8px; padding:8px; font-weight:600; cursor:pointer; color:#fff; font-size:13px; }
    button.primary { background: #2563eb; }
    button.success { background: #059669; }
    button.warn { background: #f59e0b; color:#000; }
    button.danger { background: #dc2626; }

    .statusbar { text-align:center; font-size: 12px; color: var(--muted); }

    main { flex:1; display:flex; flex-direction: column; padding: 6px; gap:6px; }

    .viewport-wrap { flex:1; background:#0a0f18; border-radius: var(--radius); position: relative; overflow:hidden; }
    .viewport { position: absolute; inset: 0; perspective: 900px; }
    .world { position:absolute; inset:0; transform-style: preserve-3d; }
    .cube { position:absolute; top:50%; left:50%; transform-style: preserve-3d; width: var(--cube); height: var(--cube); transform: translate(-50%, -50%); }
    .face { position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size: clamp(22px, 6vw, 32px); font-weight:800; color:#fff; background: rgba(21,30,45,.85); border:1px solid rgba(255,255,255,.1); }
    .front  { transform: translateZ(calc(var(--cube) / 2)); }
    .back   { transform: rotateY(180deg) translateZ(calc(var(--cube) / 2)); }
    .right  { transform: rotateY(90deg) translateZ(calc(var(--cube) / 2)); }
    .left   { transform: rotateY(-90deg) translateZ(calc(var(--cube) / 2)); }
    .top    { transform: rotateX(90deg) translateZ(calc(var(--cube) / 2)); }
    .bottom { transform: rotateX(-90deg) translateZ(calc(var(--cube) / 2)); }

    .hud { background: var(--panel); border-radius: var(--radius); padding: 6px; font-size:12px; display: grid; grid-template-columns: repeat(2, 1fr); gap:4px; }
    .hud h2 { grid-column: 1/-1; font-size: 13px; margin:0 0 4px; text-align:center; }
    .kv { display:flex; justify-content:space-between; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:11px; padding:2px 0; }

    footer { padding: 6px; font-size: 11px; text-align:center; background: var(--panel); }

    .modal { position: fixed; inset: 0; display:none; place-items:center; background: rgba(0,0,0,.7); z-index: 50; }
    .modal.open { display:grid; }
    .modal-card { width: 95vw; max-height: 85vh; background: var(--bg); border-radius: var(--radius); display:flex; flex-direction:column; overflow: hidden; }
    .modal-body { padding: 6px; flex:1; overflow:auto; }
    textarea { width: 100%; min-height: 60vh; border:none; background:#000; color:#0f0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 11px; padding: 6px; }
    .modal-actions { display:flex; justify-content:space-around; padding: 6px; background: var(--panel); }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Giroscópio Tester — 1ª Pessoa</h1>
    <div class="controls">
      <button id="btn-permission" class="warn">Permitir</button>
      <button id="btn-calibrate" class="success">Recalibrar</button>
      <button id="btn-start" class="primary">Iniciar</button>
      <button id="btn-stop" class="danger">Parar</button>
    </div>
    <div class="statusbar" id="status-text">Aguardando…</div>
  </header>

  <main>
    <section class="viewport-wrap">
      <div class="viewport">
        <div class="world" id="world">
          <div class="cube">
            <div class="face front">Frente</div>
            <div class="face back">Trás</div>
            <div class="face right">Direita</div>
            <div class="face left">Esquerda</div>
            <div class="face top">Cima</div>
            <div class="face bottom">Baixo</div>
          </div>
        </div>
      </div>
    </section>

    <aside class="hud">
      <h2>HUD</h2>
      <div class="kv"><span>alpha</span><b id="alpha">—</b></div>
      <div class="kv"><span>beta</span><b id="beta">—</b></div>
      <div class="kv"><span>gamma</span><b id="gamma">—</b></div>
      <div class="kv"><span>yaw</span><b id="yaw">—</b></div>
      <div class="kv"><span>pitch</span><b id="pitch">—</b></div>
      <div class="kv"><span>roll</span><b id="roll">—</b></div>
      <div class="kv"><span>face</span><b id="face">—</b></div>
      <div class="kv"><span>orientação</span><b id="orientation">—</b></div>
    </aside>
  </main>

  <footer>© Tester Gyro v1.5</footer>
</div>

<div class="modal" id="debug-modal">
  <div class="modal-card">
    <div class="modal-body">
      <textarea id="debug-text" readonly></textarea>
    </div>
    <div class="modal-actions">
      <button id="btn-copy" class="primary">Copiar</button>
      <button id="btn-close-modal" class="danger">Fechar</button>
    </div>
  </div>
</div>

<script>
(function(){
  const deg2rad = d => d * Math.PI / 180;
  const rad2deg = r => r * 180 / Math.PI;
  function qMul(a,b){const[aw,ax,ay,az]=a,[bw,bx,by,bz]=b;return[aw*bw-ax*bx-ay*by-az*bz,aw*bx+ax*bw+ay*bz-az*by,aw*by-ax*bz+ay*bw+az*bx,aw*bz+ax*by-ay*bx+az*bw];}
  function qConj(q){return[q[0],-q[1],-q[2],-q[3]];}
  function eulerZXYToQuat(alpha,beta,gamma){
    const z=deg2rad(alpha), x=deg2rad(beta), y=deg2rad(gamma);
    const qz=[Math.cos(z/2),0,0,Math.sin(z/2)];
    const qx=[Math.cos(x/2),Math.sin(x/2),0,0];
    const qy=[Math.cos(y/2),0,Math.sin(y/2),0];
    return qMul(qMul(qz,qx),qy);
  }
  function applyScreenQuat(q, angleDeg){
    const z=deg2rad(-angleDeg);
    const qz=[Math.cos(z/2),0,0,Math.sin(z/2)];
    return qMul(q,qz);
  }
  function quatToYPR(q){
    const [w,x,y,z]=q;
    const siny_cosp=2*(w*z+x*y); const cosy_cosp=1-2*(y*y+z*z); const yaw=Math.atan2(siny_cosp,cosy_cosp);
    const sinp=2*(w*y - z*x); const pitch=Math.abs(sinp)>=1?Math.sign(sinp)*Math.PI/2:Math.asin(sinp);
    const sinr_cosp=2*(w*x + y*z); const cosr_cosp=1-2*(x*x + y*y); const roll=Math.atan2(sinr_cosp,cosr_cosp);
    return { yaw:rad2deg(yaw), pitch:rad2deg(pitch), roll:rad2deg(roll) };
  }
  function normalizeDeg(a){ let d=a%360; if(d>180) d-=360; if(d<-180) d+=360; return d; }

  const status=document.getElementById('status-text');
  const world=document.getElementById('world');
  const debugModal=document.getElementById('debug-modal');
  const debugText=document.getElementById('debug-text');
  const orientationEl=document.getElementById('orientation');
  const btnStart=document.getElementById('btn-start');
  const btnStop=document.getElementById('btn-stop');
  const btnPerm=document.getElementById('btn-permission');
  const btnCal=document.getElementById('btn-calibrate');
  const btnCopy=document.getElementById('btn-copy');
  const btnClose=document.getElementById('btn-close-modal');

  const h={ alpha:document.getElementById('alpha'), beta:document.getElementById('beta'), gamma:document.getElementById('gamma'), yaw:document.getElementById('yaw'), pitch:document.getElementById('pitch'), roll:document.getElementById('roll'), face:document.getElementById('face') };

  let running=false, rafId=0, lastSample=0; const sampleHz=2, sampleInterval=1000/sampleHz;
  let raw={ alpha:0,beta:0,gamma:0, absolute:false };
  let screenAngle=getScreenAngle();
  let qCal=[1,0,0,0];
  const logs={ meta:{ version:'1.5', startedAt:null, endedAt:null, sampleHz }, device:[], interpreted:[] };

  function getScreenAngle(){ if(screen.orientation&&typeof screen.orientation.angle==='number') return screen.orientation.angle; return typeof window.orientation==='number'?window.orientation:0; }
  window.addEventListener('orientationchange',()=>{screenAngle=getScreenAngle();});

  async function requestPermissionIfNeeded(){ if(!window.DeviceOrientationEvent) return true; if(typeof DeviceOrientationEvent.requestPermission==='function'){ try{ return (await DeviceOrientationEvent.requestPermission())==='granted'; }catch{return false;} } return true; }
  btnPerm.addEventListener('click',async()=>{const ok=await requestPermissionIfNeeded();status.textContent=ok?'Permissão concedida.':'Permissão negada.';});

  window.addEventListener('deviceorientation',(e)=>{ if(typeof e.alpha==='number') raw.alpha=e.alpha; if(typeof e.beta==='number') raw.beta=e.beta; if(typeof e.gamma==='number') raw.gamma=e.gamma; raw.absolute=!!e.absolute; },{passive:true});

  function computeCurrentQuat(){ return applyScreenQuat(eulerZXYToQuat(raw.alpha,raw.beta,raw.gamma),screenAngle); }
  function currentCalibratedQuat(){ return qMul(qConj(qCal),computeCurrentQuat()); }
  btnCal.addEventListener('click',()=>{ qCal=computeCurrentQuat(); status.textContent='Recalibrado: posição atual = Frente.'; });

  function faceFrom(yaw, pitch) {
    // Pitch controla Cima/Baixo
    if (pitch > 140) return 'Cima';
    if (pitch < 20) return 'Baixo';
  
    // Yaw controla Esquerda/Direita
    if (yaw > 45) return 'Esquerda';
    if (yaw < -45) return 'Direita';
  
    // Posição neutra
    return 'Frente';
  }

  }

  function tick(ts){
    if(!running) return;
    const qRel=currentCalibratedQuat();
    const ypr=quatToYPR(qRel);
    world.style.transform=`rotateZ(${-ypr.yaw}deg) rotateX(${-ypr.pitch}deg) rotateY(${ypr.roll}deg)`;
    const face=faceFrom(ypr.yaw,ypr.pitch);
    h.alpha.textContent=raw.alpha.toFixed(1);
    h.beta.textContent=raw.beta.toFixed(1);
    h.gamma.textContent=raw.gamma.toFixed(1);
    h.yaw.textContent=ypr.yaw.toFixed(1);
    h.pitch.textContent=ypr.pitch.toFixed(1);
    h.roll.textContent=ypr.roll.toFixed(1);
    h.face.textContent=face;
    orientationEl.textContent=(Math.abs(screenAngle)===90)?'Paisagem':'Retrato';
    if(ts-lastSample>=sampleInterval){ lastSample=ts; const t=Date.now(); logs.device.push({t,alpha:raw.alpha,beta:raw.beta,gamma:raw.gamma,absolute:raw.absolute,screenAngle}); logs.interpreted.push({t,yaw:ypr.yaw,pitch:ypr.pitch,roll:ypr.roll,face,orientation:(Math.abs(screenAngle)===90)?'landscape':'portrait'}); }
    rafId=requestAnimationFrame(tick);
  }

  btnStart.onclick=async()=>{ const ok=await requestPermissionIfNeeded(); if(!ok){status.textContent='Permissão negada.';return;} running=true; logs.device.length=0; logs.interpreted.length=0; logs.meta.startedAt=new Date().toISOString(); logs.meta.endedAt=null; lastSample=performance.now(); status.textContent='Gravando…'; if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();} rafId=requestAnimationFrame(tick); };
  btnStop.onclick=()=>{ if(!running) return; running=false; cancelAnimationFrame(rafId); logs.meta.endedAt=new Date().toISOString(); status.textContent='Parado'; const payload={meta:logs.meta,device:logs.device,interpreted:logs.interpreted}; debugText.value=JSON.stringify(payload,null,2); debugModal.classList.add('open'); };
  btnClose.onclick=()=>debugModal.classList.remove('open');
  btnCopy.onclick=()=>navigator.clipboard.writeText(debugText.value);
})();
</script>
</body>
</html>

