<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <title>FPS 3D — Protótipo</title>
  <style>
    :root{ --navy:#0b2a6b; --navy2:#001021; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:#000; color:#e6ebf5; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body{ overflow:hidden; -webkit-tap-highlight-color: transparent; }
    #menu{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; gap:2rem;
      background: radial-gradient(1000px 700px at 50% 20%, rgba(11,42,107,.25), transparent 60%),
                  linear-gradient(180deg, #000 0%, #000 100%);
      user-select:none; transition:opacity .35s ease, visibility .35s ease; z-index:3;
    }
    #logo{
      text-align:center; line-height:1.2;
    }
    #logo h1{ font-size: clamp(28px, 4vw, 46px); margin:0; letter-spacing:.5px; }
    #logo p{ margin:.5rem 0 1.5rem; opacity:.8; font-size: clamp(14px, 1.8vw, 16px); }
    .btn{
      appearance:none; border:none; cursor:pointer; padding:14px 28px; font-weight:700; font-size:16px; border-radius:14px;
      background: linear-gradient(135deg, var(--navy2) 0%, var(--navy) 100%);
      color:#e6ebf5; box-shadow: 0 10px 30px rgba(11,42,107,.35), inset 0 1px 0 rgba(255,255,255,.06);
      transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 36px rgba(11,42,107,.5), inset 0 1px 0 rgba(255,255,255,.08); }
    .btn:active{ transform: translateY(0); filter: brightness(.95); }
    .footer{ position:fixed; bottom:16px; left:0; right:0; display:flex; justify-content:center; font-size:12px; opacity:.5; }
    
    #gameWrap{ position:fixed; inset:0; display:none; }
    canvas{ width:100%; height:100%; display:block; touch-action:none; }
    
    /* Subtle fade-in when game starts */
    .show{ display:block; animation: fade .4s ease both; }
    @keyframes fade{ from{ opacity:0 } to{ opacity:1 } }
  </style>
  <!-- Babylon.js CDN (core only) -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
</head>
<body>
  <!-- MENU -->
  <div id="menu">
    <div id="logo">
      <h1>FPS 3D • Protótipo</h1>
      <p>HTML + WebGL. Toque ou clique para entrar. Cores: preto & azul‑marinho.</p>
      <button id="play" class="btn" aria-label="Jogar">Jogar</button>
      <div class="footer">Dica: no iOS pode aparecer um pedido de permissão do giroscópio.</div>
    </div>
  </div>

  <!-- GAME CANVAS -->
  <div id="gameWrap"><canvas id="game"></canvas></div>

  <script>
    const menu = document.getElementById('menu');
    const playBtn = document.getElementById('play');
    const wrap = document.getElementById('gameWrap');
    const canvas = document.getElementById('game');

    let engine = null, scene = null, camera = null;

    const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    playBtn.addEventListener('click', async () => {
      // Hide menu UI
      menu.style.opacity = '0';
      menu.style.visibility = 'hidden';
      wrap.classList.add('show');

      // iOS 13+ requires explicit permission for motion/orientation
      const gyroGranted = await requestMotionPermission();

      startEngine({ useGyro: gyroGranted && isMobileUA });

      // For desktop: engage pointer lock for mouse look
      if (!isMobileUA) {
        requestPointerLock(canvas);
      }
    }, { passive: true });

    function requestPointerLock(el){
      const lock = () => { if (el.requestPointerLock) el.requestPointerLock(); };
      // try immediately
      lock();
      // also on click/touch inside canvas
      el.addEventListener('click', lock);
      el.addEventListener('touchstart', lock, {passive:true});
      document.addEventListener('keydown', (e)=>{ if(e.code==='Escape'){ document.exitPointerLock?.(); } });
    }

    async function requestMotionPermission(){
      try{
        // Newer iOS: DeviceMotionEvent first
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
          const r = await DeviceMotionEvent.requestPermission();
          if (r === 'granted') return true;
        }
        // Fallback: DeviceOrientationEvent
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
          const r2 = await DeviceOrientationEvent.requestPermission();
          if (r2 === 'granted') return true;
        }
      }catch(err){ /* ignore */ }
      // On Android/desktop this permission API may not exist; we return false and use mouse controls.
      return false;
    }

    function startEngine({useGyro=false}={}){
      engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer:false, stencil:true, disableWebGL2Support:false });
      scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color4(0,0,0,1); // cenário 100% preto

      // Choose camera according to capability
      if (useGyro){
        camera = new BABYLON.DeviceOrientationCamera('cam', new BABYLON.Vector3(0, 1.6, 0), scene);
        // Allow touch to also rotate when using gyro
        camera._disablePointerInputWhenUsingDeviceOrientation = false;
        camera.attachControl(canvas, true);
      } else {
        camera = new BABYLON.UniversalCamera('cam', new BABYLON.Vector3(0, 1.6, 0), scene);
        camera.attachControl(canvas, true);
      }

      // FPS-like look only (sem movimento WASD)
      camera.speed = 0; // evita deslocamento
      camera.keysUp = camera.keysDown = camera.keysLeft = camera.keysRight = [];

      // === Luz e geometria básica ===
      // Luz ambiente suave para a sala escura
      const hemi = new BABYLON.HemisphericLight('hemi', new BABYLON.Vector3(0, 1, 0), scene);
      hemi.intensity = 0.35;

      // Uma luz pontual fraca acima da câmera para dar contraste
      const point = new BABYLON.PointLight('point', new BABYLON.Vector3(0, 2.5, 1.5), scene);
      point.intensity = 0.5;

      // Sala: caixa invertida para olharmos de dentro (10m)
      const room = BABYLON.MeshBuilder.CreateBox('room', { size: 10, sideOrientation: BABYLON.Mesh.BACKSIDE }, scene);
      const roomMat = new BABYLON.StandardMaterial('roomMat', scene);
      roomMat.diffuseColor = new BABYLON.Color3(0.05, 0.06, 0.08); // quase preta
      roomMat.specularColor = new BABYLON.Color3(0, 0, 0);
      room.material = roomMat;

      // Cubo de referência "de pedra" no lado oposto da sala
      const ref = BABYLON.MeshBuilder.CreateBox('ref', { size: 1 }, scene);
      ref.position = new BABYLON.Vector3(0, 1, -3.5);
      const refMat = new BABYLON.StandardMaterial('refMat', scene);
      refMat.diffuseColor = new BABYLON.Color3(0.25, 0.25, 0.28);
      refMat.specularColor = new BABYLON.Color3(0.02, 0.02, 0.02);
      refMat.emissiveColor = new BABYLON.Color3(0.01, 0.01, 0.015); // levemente visível na escuridão
      try {
        refMat.diffuseTexture = new BABYLON.Texture('https://playground.babylonjs.com/textures/rock.png', scene);
      } catch (e) { /* se falhar, fica só a cor difusa */ }
      ref.material = refMat;

      // Parâmetros de câmera
      camera.minZ = 0.05;
      camera.maxZ = 100;
      camera.fov = BABYLON.Tools.ToRadians(75);


      // Render loop
      engine.runRenderLoop(() => { scene.render(); });
      window.addEventListener('resize', () => engine.resize());

      // Prevent gestures scrolling on mobile
      ['touchstart','touchmove','gesturestart'].forEach(evt => {
        document.addEventListener(evt, e => { if (e.target === canvas) e.preventDefault(); }, { passive:false });
      });
      // Prevent context menu
      window.addEventListener('contextmenu', e => e.preventDefault());
    }
  </script>
</body>
</html>
