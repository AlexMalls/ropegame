<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Debug Giroscópio</title>
  <style>
    body { background:#0b0f14; color:#e2e8f0; font-family:system-ui; margin:0; padding:10px; }
    button { margin:4px; padding:8px 14px; border:1px solid #334; background:#223; color:#eee; border-radius:6px; }
    .scene { width:200px; height:200px; margin:20px auto; perspective:800px; }
    #cube { width:200px; height:200px; position:relative; transform-style:preserve-3d; transition:transform 0.1s linear; }
    .face {
      position:absolute; width:200px; height:200px; border:2px solid #666;
      background:rgba(100,150,250,0.2); color:#fff; font-weight:bold;
      display:flex; align-items:center; justify-content:center; font-size:20px;
    }
    .front { transform:translateZ(100px); }
    .back { transform:rotateY(180deg) translateZ(100px); }
    .right { transform:rotateY(90deg) translateZ(100px); }
    .left { transform:rotateY(-90deg) translateZ(100px); }
    .top { transform:rotateX(90deg) translateZ(100px); }
    .bottom { transform:rotateX(-90deg) translateZ(100px); }
    #log { white-space:pre; font:12px/1.4 monospace; background:#111; padding:8px; border:1px solid #333; margin-top:12px; max-height:40vh; overflow:auto; }
  </style>
</head>
<body>
  <button id="btnStart">Iniciar</button>
  <button id="btnStop">Stop</button>
  <button id="btnCalibrate">Calibrar neutro</button>
  <div class="scene">
    <div id="cube">
      <div class="face front">FRENTE</div>
      <div class="face back">TRÁS</div>
      <div class="face right">DIREITA</div>
      <div class="face left">ESQUERDA</div>
      <div class="face top">CIMA</div>
      <div class="face bottom">BAIXO</div>
    </div>
  </div>
  <div id="log"></div>

<script>
(()=>{
  const cube=document.getElementById("cube");
  const logEl=document.getElementById("log");
  const btnStart=document.getElementById("btnStart");
  const btnStop=document.getElementById("btnStop");
  const btnCal=document.getElementById("btnCalibrate");

  let started=false, offsets={pitch:0,roll:0}, lastAngles={alpha:0,beta:0,gamma:0};
  let raf=0, intervalId=0;

  function getScreenAngle(){
    const o=screen.orientation||screen.msOrientation;
    return o&&typeof o.angle==="number"?o.angle:(window.orientation||0);
  }

  function getOrientationName() {
    const ang = getScreenAngle();
    if (ang===0) return "Portrait (normal)";
    if (ang===180) return "Portrait (de cabeça pra baixo)";
    if (ang===90) return "Landscape (botões à direita)";
    if (ang===270) return "Landscape (botões à esquerda)";
    return "Desconhecido";
  }

  function map(alpha,beta,gamma){
    const ang=((getScreenAngle()%360)+360)%360;
    let pitch,roll;
    if(ang===0){ pitch=beta; roll=gamma; }
    else if(ang===90){ pitch=gamma; roll=-beta; }
    else if(ang===180){ pitch=-beta; roll=-gamma; }
    else if(ang===270){ pitch=-gamma; roll=beta; }
    else { pitch=beta; roll=gamma; }
    return {pitch,roll,screenAngle:ang};
  }

  function onOrientation(e){
    lastAngles={
      alpha:e.alpha||0,
      beta:e.beta||0,
      gamma:e.gamma||0
    };
  }

  function tick(){
    const {alpha,beta,gamma}=lastAngles;
    const m=map(alpha,beta,gamma);
    const pitch=m.pitch-offsets.pitch;
    const roll=m.roll-offsets.roll;
    cube.style.transform=`rotateX(${pitch}deg) rotateY(${roll}deg)`;
    raf=requestAnimationFrame(tick);
  }

  function start(){
    if(started) return;
    started=true;
    logEl.textContent+=`>>> Iniciado. Orientação inicial: ${getOrientationName()}\n`;
    window.addEventListener("deviceorientation",onOrientation,{passive:true});
    raf=requestAnimationFrame(tick);

    intervalId=setInterval(()=>{
      const {alpha,beta,gamma}=lastAngles;
      const m=map(alpha,beta,gamma);
      const pitch=m.pitch-offsets.pitch;
      const roll=m.roll-offsets.roll;
      logEl.textContent+=
        `t=${Date.now()%1e6}\n`+
        `raw: α=${alpha.toFixed(1)} β=${beta.toFixed(1)} γ=${gamma.toFixed(1)}\n`+
        `mapped: pitch=${m.pitch.toFixed(1)} roll=${m.roll.toFixed(1)} screenAngle=${m.screenAngle}\n`+
        `offsets: pitch0=${offsets.pitch.toFixed(1)} roll0=${offsets.roll.toFixed(1)}\n`+
        `applied: pitch=${pitch.toFixed(1)} roll=${roll.toFixed(1)}\n---\n`;
      logEl.scrollTop=logEl.scrollHeight;
    },1000);
  }

  function stop(){
    if(!started) return;
    started=false;
    cancelAnimationFrame(raf);
    clearInterval(intervalId);
    window.removeEventListener("deviceorientation",onOrientation);
    logEl.textContent+=">>> Parado\n";
  }

  function calibrate(){
    const m=map(lastAngles.alpha,lastAngles.beta,lastAngles.gamma);
    offsets.pitch=m.pitch;
    offsets.roll=m.roll;
    logEl.textContent+=">>> Calibrado\n";
  }

  btnStart.addEventListener("click",start);
  btnStop.addEventListener("click",stop);
  btnCal.addEventListener("click",calibrate);
})();
</script>
</body>
</html>
