<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Debug Giroscópio</title>
  <style>
    body { background:#0b0f14; color:#e2e8f0; font-family:system-ui; margin:0; padding:10px; }
    button { margin:4px; padding:8px 14px; border:1px solid #334; background:#223; color:#eee; border-radius:6px; }
    #cube { margin:20px auto; width:120px; height:120px; transform-style:preserve-3d; perspective:800px; }
    .face { position:absolute; width:120px; height:120px; border:1px solid #666; background:#2a3; opacity:.8; }
    .f1{transform:translateZ(60px);} .f2{transform:rotateY(180deg) translateZ(60px);}
    .f3{transform:rotateY(90deg) translateZ(60px);} .f4{transform:rotateY(-90deg) translateZ(60px);}
    .f5{transform:rotateX(90deg) translateZ(60px);} .f6{transform:rotateX(-90deg) translateZ(60px);}
    #log { white-space:pre; font:12px/1.4 monospace; background:#111; padding:8px; border:1px solid #333; margin-top:12px; max-height:45vh; overflow:auto; }
  </style>
</head>
<body>
  <button id="btnStart">Iniciar</button>
  <button id="btnCalibrate">Calibrar neutro</button>
  <div id="cube">
    <div class="face f1">1</div><div class="face f2">2</div>
    <div class="face f3">3</div><div class="face f4">4</div>
    <div class="face f5">5</div><div class="face f6">6</div>
  </div>
  <div id="log"></div>

<script>
(()=>{
  const cube=document.getElementById("cube");
  const logEl=document.getElementById("log");
  const btnStart=document.getElementById("btnStart");
  const btnCal=document.getElementById("btnCalibrate");

  let started=false, offsets={pitch:0,roll:0}, lastAngles={alpha:0,beta:0,gamma:0};
  let raf=0, intervalId=0;

  function getScreenAngle(){
    const o=screen.orientation||screen.msOrientation;
    return o&&typeof o.angle==="number"?o.angle:(window.orientation||0);
  }

  function map(alpha,beta,gamma){
    const ang=((getScreenAngle()%360)+360)%360;
    let pitch,roll;
    if(ang===0){ pitch=beta; roll=gamma; }
    else if(ang===90){ pitch=gamma; roll=-beta; }
    else if(ang===180){ pitch=-beta; roll=-gamma; }
    else if(ang===270){ pitch=-gamma; roll=beta; }
    else { pitch=beta; roll=gamma; }
    return {pitch,roll,screenAngle:ang};
  }

  function onOrientation(e){
    lastAngles={
      alpha:e.alpha||0,
      beta:e.beta||0,
      gamma:e.gamma||0
    };
  }

  function tick(){
    const {alpha,beta,gamma}=lastAngles;
    const m=map(alpha,beta,gamma);
    const pitch=m.pitch-offsets.pitch;
    const roll=m.roll-offsets.roll;
    cube.style.transform=`rotateX(${pitch}deg) rotateY(${roll}deg)`;
    raf=requestAnimationFrame(tick);
  }

  function start(){
    if(started) return;
    started=true;
    window.addEventListener("deviceorientation",onOrientation,{passive:true});
    raf=requestAnimationFrame(tick);

    // inicia debug log 1x/seg
    intervalId=setInterval(()=>{
      const {alpha,beta,gamma}=lastAngles;
      const m=map(alpha,beta,gamma);
      const pitch=m.pitch-offsets.pitch;
      const roll=m.roll-offsets.roll;
      logEl.textContent+=
        `t=${Date.now()%1e6}\n`+
        `raw: α=${alpha.toFixed(1)} β=${beta.toFixed(1)} γ=${gamma.toFixed(1)}\n`+
        `mapped: pitch=${m.pitch.toFixed(1)} roll=${m.roll.toFixed(1)} screenAngle=${m.screenAngle}\n`+
        `offsets: pitch0=${offsets.pitch.toFixed(1)} roll0=${offsets.roll.toFixed(1)}\n`+
        `applied: pitch=${pitch.toFixed(1)} roll=${roll.toFixed(1)}\n---\n`;
      logEl.scrollTop=logEl.scrollHeight;
    },1000);
  }

  function calibrate(){
    const m=map(lastAngles.alpha,lastAngles.beta,lastAngles.gamma);
    offsets.pitch=m.pitch;
    offsets.roll=m.roll;
    logEl.textContent+=">>> Calibrado\n";
  }

  btnStart.addEventListener("click",start);
  btnCal.addEventListener("click",calibrate);
})();
</script>
</body>
</html>
