<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Balanço na Corda 3D (Quaternion + Deroll)</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background: black; font-family: system-ui, sans-serif; }
    canvas { display: block; }
    #hud { position: fixed; top: 0; left: 0; right: 0; padding: 10px; display: flex; align-items: center; gap: 10px; pointer-events: none; }
    .bar { flex: 1; height: 8px; background: rgba(255,255,255,0.15); border-radius: 999px; overflow: hidden; }
    .fill { height: 100%; background: linear-gradient(90deg, #7bdcff, #91ffb1); width: 0%; }
    .chip { background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 999px; font-size: 12px; color:#eee; }
    #overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); color: white; text-align: center; }
    #panel { background: rgba(0,0,0,0.85); padding: 20px; border-radius: 12px; max-width: 620px; }
    button { margin-top: 12px; padding: 10px 16px; background: #222; color: #eee; border: 1px solid #555; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { background: #333; }
    [hidden] { display: none !important; }
    #debugWrap { position: fixed; top: 10px; right: 10px; display: none; gap: 8px; align-items: flex-start; }
    #debug { background: rgba(0,0,0,0.6); color: #0f0; font-family: monospace; font-size: 12px; padding: 8px; border-radius: 6px; white-space: pre; }
  </style>
</head>
<body>
  <div id="hud">
    <div class="chip">Use A/D ou mova o celular</div>
    <div class="bar"><div class="fill" id="fill"></div></div>
    <div class="chip" id="status">Pronto</div>
  </div>

  <div id="overlay">
    <div id="panel">
      <h1>Balanço na Corda 3D</h1>
      <button id="play">Jogar</button>
      <button id="calibrate">Calibragem</button>
      <button id="back" hidden>Voltar</button>
    </div>
  </div>

  <div id="debugWrap"><div id="debug"></div></div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script>
  (() => {
    let scene, camera, renderer, rope, floor;
    let angle=0, angVel=0, drift=0, driftTarget=0, driftTimer=0;
    const maxAngle=0.5, damping=0.985, baseControlPower=1.5, baseSpeed=0.05;
    let progress=0, gameOverFlag=false, isCalibrating=false;

    const overlay=document.getElementById('overlay');
    const playBtn=document.getElementById('play');
    const calibrateBtn=document.getElementById('calibrate');
    const backBtn=document.getElementById('back');
    const fillEl=document.getElementById('fill');
    const statusEl=document.getElementById('status');
    const debugWrap=document.getElementById('debugWrap');
    const debugEl=document.getElementById('debug');

    // quaternions
    const qDevice=new THREE.Quaternion(), refInv=new THREE.Quaternion(), qLook=new THREE.Quaternion(), qBalance=new THREE.Quaternion(), qCombined=new THREE.Quaternion();
    const euler=new THREE.Euler(0,0,0,'YXZ'); const fwd=new THREE.Vector3(0,0,-1);
    let haveDeviceQuat=false, haveRef=false;

    function defineRef(){ if(haveDeviceQuat){ refInv.copy(qDevice).invert(); haveRef=true; } }
    function buildLookQuaternion(){
      if(haveDeviceQuat){ if(!haveRef) defineRef(); qLook.copy(refInv).multiply(qDevice);
        const dir=fwd.clone().applyQuaternion(qLook); const yaw=Math.atan2(dir.x,-dir.z); const pitch=Math.asin(Math.max(-1,Math.min(1,dir.y)));
        euler.set(pitch,yaw,0,'YXZ'); qLook.setFromEuler(euler);
      } else { qLook.identity(); }
    }

    function initScene(){
      scene=new THREE.Scene();
      camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
      camera.position.set(0,1.6,5);
      renderer=new THREE.WebGLRenderer({antialias:true});
      renderer.setSize(innerWidth,innerHeight);
      document.body.appendChild(renderer.domElement);

      const light=new THREE.HemisphereLight(0xffffff,0x444444,1); scene.add(light);
      floor=new THREE.Mesh(new THREE.PlaneGeometry(200,200), new THREE.MeshBasicMaterial({color:0xff3300,wireframe:true}));
      floor.rotation.x=-Math.PI/2; floor.position.y=-5; scene.add(floor);
      rope=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.05,100), new THREE.MeshStandardMaterial({color:0xaaa})); scene.add(rope);
      window.addEventListener('resize',()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
    }

    function start(calMode){
      isCalibrating=calMode; overlay.hidden=true; debugWrap.style.display=calMode?'block':'none';
      angle=0; angVel=0; progress=0; gameOverFlag=false; haveRef=false;
      initScene(); animate();
    }
    playBtn.onclick=()=>start(false); calibrateBtn.onclick=()=>start(true); backBtn.onclick=()=>{ overlay.hidden=false; debugWrap.style.display='none'; gameOverFlag=true; };

    window.addEventListener('deviceorientation',(e)=>{
      const a=THREE.MathUtils.degToRad(e.alpha||0), b=THREE.MathUtils.degToRad(e.beta||0), g=THREE.MathUtils.degToRad(e.gamma||0);
      const q=new THREE.Quaternion().setFromEuler(new THREE.Euler(b,a,-g,'YXZ'));
      qDevice.copy(q); haveDeviceQuat=true;
    });

    function update(dt){
      buildLookQuaternion();
      if(isCalibrating){ qCombined.multiplyQuaternions(qLook,qBalance.identity()); camera.quaternion.copy(qCombined);
        debugEl.textContent=`Quat: ${qLook.x.toFixed(2)},${qLook.y.toFixed(2)},${qLook.z.toFixed(2)},${qLook.w.toFixed(2)}\nRoll:${angle.toFixed(2)}`; return; }

      driftTimer-=dt; if(driftTimer<=0){ driftTimer=1+Math.random()*1.5; driftTarget=(Math.random()*2-1)*1.2; } drift+=(driftTarget-drift)*(1-Math.pow(0.001,dt));
      angVel+=(drift*0.5)*dt; angVel*=Math.pow(damping,dt*60); angle+=angVel*dt;

      qBalance.setFromAxisAngle(new THREE.Vector3(0,0,1),angle); qCombined.multiplyQuaternions(qLook,qBalance); camera.quaternion.copy(qCombined);
      camera.position.z-=2*dt;

      progress=Math.min(1,progress+baseSpeed*dt); fillEl.style.width=(progress*100)+'%'; statusEl.textContent=Math.abs(angle)>=maxAngle*0.8?'Perigo!':'Equilibre-se';
      if(Math.abs(angle)>maxAngle) return gameOver(false); if(progress>=1) return gameOver(true);
    }

    let last=performance.now(); function animate(){ if(gameOverFlag)return; requestAnimationFrame(animate);
      const now=performance.now(),dt=Math.min(0.05,(now-last)/1000); last=now; update(dt); renderer.render(scene,camera); }

    function gameOver(win){ gameOverFlag=true; overlay.hidden=false; document.getElementById('panel').innerHTML= win?'<h1>Você conseguiu!</h1>':'<h1>Você caiu!</h1>'; }
  })();
  </script>
</body>
</html>
